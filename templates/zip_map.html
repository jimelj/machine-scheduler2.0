{% extends 'base.html' %}

{% block title %}{{ title }} - Map View{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 750px;
        width: 100%;
        border-radius: 4px;
        border: 1px solid #ccc;
        margin-bottom: 20px;
    }
    
    .legend {
        padding: 10px;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        margin-bottom: 10px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .day-mon {
        background-color: #ffc107;
        color: #000;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-right: 10px;
    }
    
    .day-tue {
        background-color: #17a2b8;
        color: white;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-right: 10px;
    }
    
    /* SCF/DDU styling for postal type badges */
    .postal-scf {
        background-color: #28a745;
        color: white;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-right: 10px;
    }
    
    .postal-ddu {
        background-color: #a17dc3;
        color: white;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-right: 10px;
    }
    
    .machine-info {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background-color: white;
        padding: 5px 10px;
        border-radius: 4px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        font-size: 0.8rem;
    }
    
    .zip-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 10px;
    }
    
    .zip-item {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 8px;
        background-color: #f8f9fa;
        transition: all 0.2s ease;
    }
    
    .zip-item:hover {
        background-color: #e9ecef;
        cursor: pointer;
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .zip-item.active {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
    }
    
    .zip-item.active .badge {
        background-color: white !important;
        color: #007bff !important;
    }
    
    .accordion-button:not(.collapsed) {
        background-color: rgba(0, 123, 255, 0.1);
        color: #0d6efd;
    }
    
    .zip-count-badge {
        font-size: 0.7rem;
        vertical-align: middle;
        margin-left: 5px;
    }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>{{ title }}</h2>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <p class="lead">Interactive map of ZIP codes assigned to machines.</p>
            <a href="{{ url_for('view_schedule') }}" class="btn btn-secondary">Back to Schedule</a>
        </div>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-2">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Filters</h5>
            </div>
            <div class="card-body">
                <!-- Machine filter -->
                <div class="mb-2">
                    <label class="form-label small">Machine:</label>
                    <div class="btn-group-vertical w-100" role="group">
                        <a href="{{ url_for('view_zip_map') }}" class="btn btn-sm mb-1 py-1 btn-{% if machine_id is none %}primary{% else %}outline-primary{% endif %}">All Machines</a>
                        {% for id, name in machine_names.items()|sort %}
                        <a href="{{ url_for('view_zip_map', machine_id=id) }}" 
                           class="btn btn-sm mb-1 py-1 btn-{% if machine_id == id %}primary{% else %}outline-primary{% endif %}"
                           id="machine-btn-{{ id }}">
                            {{ name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Delivery day filter -->
                <div class="mb-2">
                    <label class="form-label small">
                        {% if scheduling_method == 'Postal Facility (SCF/DDU)' %}
                            Postal Type:
                        {% elif scheduling_method == 'Mayhem ☠️ (No Logic)' %}
                            <!-- Hidden in Mayhem mode -->
                        {% else %}
                            Delivery Day:
                        {% endif %}
                    </label>
                    <div class="btn-group w-100" role="group">
                        {% if scheduling_method == 'Postal Facility (SCF/DDU)' %}
                            <button class="btn btn-sm btn-outline-success py-1 filter-btn" id="filter-scf" data-filter="SCF" style="flex: 1;">SCF</button>
                            <button class="btn btn-sm py-1 filter-btn" id="filter-ddu" data-filter="DDU" style="flex: 1; border: 1px solid #a17dc3; color: #a17dc3;">DDU</button>
                            <button class="btn btn-sm btn-outline-secondary py-1 filter-btn" id="filter-all" data-filter="ALL" style="flex: 1;">All</button>
                        {% elif scheduling_method == 'Mayhem ☠️ (No Logic)' %}
                            <!-- No filters in Mayhem mode -->
                        {% else %}
                            <button class="btn btn-sm btn-outline-warning py-1 filter-btn" id="filter-mon" data-filter="MON" style="flex: 1;">Mon</button>
                            <button class="btn btn-sm btn-outline-info py-1 filter-btn" id="filter-tue" data-filter="TUE" style="flex: 1;">Tue</button>
                            <button class="btn btn-sm btn-outline-secondary py-1 filter-btn" id="filter-all" data-filter="ALL" style="flex: 1;">All</button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="mt-3">
                    <h6 class="small">Legend:</h6>
                    {% if scheduling_method == 'Postal Facility (SCF/DDU)' %}
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #28a745;"></span>
                            <span class="small">SCF</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #a17dc3;"></span>
                            <span class="small">DDU</span>
                        </div>
                    {% elif scheduling_method == 'Mayhem ☠️ (No Logic)' %}
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #dc3545;"></span>
                            <span class="small">ZIP Codes</span>
                        </div>
                    {% else %}
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #ffc107;"></span>
                            <span class="small">Monday Delivery</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #17a2b8;"></span>
                            <span class="small">Tuesday Delivery</span>
                        </div>
                    {% endif %}
                    <div class="mt-2 text-muted small">
                        Numbers show sequence order.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-10">
        <!-- Map container -->
        <div id="map"></div>
        
        <div class="alert alert-info">
            <p><strong>Note:</strong> ZIP code coordinates are approximate and based on centroid calculations.</p>
            <p class="mb-0">ZIP codes that cannot be geocoded will not appear on the map.</p>
        </div>
    </div>
</div>

<!-- ZIP codes accordion section at the bottom -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ZIP Codes by Machine ({{ zips|length }} total)</h5>
                <div>
                    <button id="expandAllBtn" class="btn btn-sm btn-light">Expand All</button>
                </div>
            </div>
            <div class="card-body">
                <div class="accordion" id="zipCodesAccordion">
                    {% if machine_id is none %}
                        {% for machine_id, name in machine_names.items()|sort %}
                            {% set machine_zips = zips|selectattr('machine_id', 'equalto', machine_id)|list %}
                            {% if machine_zips|length > 0 %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading{{ machine_id }}">
                                        <button class="accordion-button collapsed" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#collapse{{ machine_id }}" 
                                                aria-expanded="false" aria-controls="collapse{{ machine_id }}">
                                            {{ name }} <span class="badge bg-primary zip-count-badge">{{ machine_zips|length }} ZIPs</span>
                                        </button>
                                    </h2>
                                    <div id="collapse{{ machine_id }}" class="accordion-collapse collapse" 
                                         aria-labelledby="heading{{ machine_id }}" data-bs-parent="#zipCodesAccordion">
                                        <div class="accordion-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>ZIP Code</th>
                                                            <th>Delivery Day</th>
                                                            <th>Postal</th>
                                                            <th>Segments</th>
                                                            <th>Insert Count</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for zip in machine_zips|sort(attribute='sequence') %}
                                                        <tr class="zip-list-item" 
                                                            data-zip="{{ zip.zip_code }}" 
                                                            data-mailday="{{ zip.mailday }}"
                                                            data-machine="{{ zip.machine_id }}">
                                                            <td><strong>{{ zip.zip_code }}</strong></td>
                                                            <td>
                                                                {% if zip.mailday == 'MON' %}
                                                                <span class="badge bg-warning text-dark">Monday</span>
                                                                {% elif zip.mailday == 'TUE' %}
                                                                <span class="badge bg-info text-white">Tuesday</span>
                                                                {% else %}
                                                                <span class="badge bg-secondary">{{ zip.mailday }}</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if zip.postal_type == 'SCF' %}
                                                                <span class="badge postal-scf">SCF</span>
                                                                {% elif zip.postal_type == 'DDU' %}
                                                                <span class="badge postal-ddu">DDU</span>
                                                                {% else %}
                                                                <span class="badge bg-secondary">{{ zip.postal_type|default('-') }}</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if zip.segments %}
                                                                    {% for segment in zip.segments %}
                                                                    <span class="badge bg-secondary me-1">{{ segment }}</span>
                                                                    {% endfor %}
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>{{ zip.insert_count|default('10', true) }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingMachine">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapseMachine" 
                                        aria-expanded="false" aria-controls="collapseMachine">
                                    {{ machine_names[machine_id] }} <span class="badge bg-primary zip-count-badge">{{ zips|length }} ZIPs</span>
                                </button>
                            </h2>
                            <div id="collapseMachine" class="accordion-collapse collapse" 
                                 aria-labelledby="headingMachine" data-bs-parent="#zipCodesAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ZIP Code</th>
                                                    <th>Delivery Day</th>
                                                    <th>Postal</th>
                                                    <th>Segments</th>
                                                    <th>Insert Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for zip in zips|sort(attribute='sequence') %}
                                                <tr class="zip-list-item" 
                                                    data-zip="{{ zip.zip_code }}" 
                                                    data-mailday="{{ zip.mailday }}"
                                                    data-machine="{{ zip.machine_id }}">
                                                    <td><strong>{{ zip.zip_code }}</strong></td>
                                                    <td>
                                                        {% if zip.mailday == 'MON' %}
                                                        <span class="badge bg-warning text-dark">Monday</span>
                                                        {% elif zip.mailday == 'TUE' %}
                                                        <span class="badge bg-info text-white">Tuesday</span>
                                                        {% else %}
                                                        <span class="badge bg-secondary">{{ zip.mailday }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if zip.postal_type == 'SCF' %}
                                                        <span class="badge postal-scf">SCF</span>
                                                        {% elif zip.postal_type == 'DDU' %}
                                                        <span class="badge postal-ddu">DDU</span>
                                                        {% else %}
                                                        <span class="badge bg-secondary">{{ zip.postal_type|default('-') }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if zip.segments %}
                                                            {% for segment in zip.segments %}
                                                            <span class="badge bg-secondary me-1">{{ segment }}</span>
                                                            {% endfor %}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ zip.insert_count|default('10', true) }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the map
        const map = L.map('map').setView([40.7831, -73.9712], 10); // NYC area
        
        // Add OpenStreetMap base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Storage for all polygons and markers to manage filtering
        const allZipLayers = [];
        const allMarkers = [];
        
        // Get ZIP code data
        const zipData = {{ zips|tojson|safe }};
        
        // Get scheduling method
        const schedulingMethod = "{{ scheduling_method }}";
        
        // Load ZIP code GeoJSON data
        async function loadZipCodeBoundaries() {
            try {
                const response = await fetch('/static/js/geodata/ny_zipcode_geo.json');
                const geoJsonData = await response.json();
                return geoJsonData;
            } catch (error) {
                console.error('Error loading ZIP code boundaries:', error);
                return null;
            }
        }
        
        // Function to add ZIP code polygons and markers
        async function initializeMap() {
            const geoJsonData = await loadZipCodeBoundaries();
            
            if (!geoJsonData) {
                // Fallback to old marker-based approach if GeoJSON data can't be loaded
                Promise.all(zipData.map(zipInfo => addZipMarker(zipInfo, true)))
                    .then(() => {
                        // Fit bounds to all markers if we have any
                        if (allMarkers.length > 0) {
                            const group = L.featureGroup(allMarkers.map(m => m.marker));
                            map.fitBounds(group.getBounds(), { padding: [30, 30] });
                        }
                    });
                return;
            }
            
            // Process each ZIP code in our data
            const processedZips = [];
            
            zipData.forEach(zipInfo => {
                // Find matching GeoJSON feature
                const geoJsonFeature = geoJsonData.features.find(
                    feature => feature.properties.ZCTA5CE10 === zipInfo.zip_code
                );
                
                if (geoJsonFeature) {
                    // Determine color based on scheduling method
                    let fillColor = '#6c757d'; // Default gray
                    let fillOpacity = 0.5;
                    let weight = 2;
                    
                    if (schedulingMethod === 'Postal Facility (SCF/DDU)') {
                        // Color by postal type
                        if (zipInfo.postal_type === 'SCF') {
                            fillColor = '#28a745'; // Green for SCF
                        } else if (zipInfo.postal_type === 'DDU') {
                            fillColor = '#a17dc3'; // Light purple for DDU
                        }
                    } else if (schedulingMethod === 'Mayhem ☠️ (No Logic)') {
                        // Mayhem mode - use red for all ZIPs
                        fillColor = '#dc3545'; // Danger red
                        fillOpacity = 0.6;
                        weight = 1.5;
                    } else {
                        // Color by delivery day
                        if (zipInfo.mailday === 'MON') {
                            fillColor = '#ffc107'; // Monday - warning yellow
                        } else if (zipInfo.mailday === 'TUE') {
                            fillColor = '#17a2b8'; // Tuesday - info blue
                        }
                    }
                    
                    // Create the polygon from GeoJSON
                    const polygon = L.geoJSON(geoJsonFeature, {
                        style: {
                            fillColor: fillColor,
                            fillOpacity: fillOpacity,
                            color: '#000',
                            weight: weight,
                            opacity: 0.8
                        }
                    }).addTo(map);
                    
                    // Add popup with info
                    const segmentsHtml = zipInfo.segments && zipInfo.segments.length ? 
                        zipInfo.segments.map(s => `<span class="badge bg-secondary me-1">${s}</span>`).join(' ') : 
                        '<span class="text-muted">-</span>';
                    
                    // Determine postal type badge
                    let postalHtml = zipInfo.postal_type || '-';
                    if (schedulingMethod === 'Postal Facility (SCF/DDU)') {
                        if (zipInfo.postal_type === 'SCF') {
                            postalHtml = '<span class="badge postal-scf">SCF</span>';
                        } else if (zipInfo.postal_type === 'DDU') {
                            postalHtml = '<span class="badge postal-ddu">DDU</span>';
                        }
                    }
                    
                    // Determine delivery day badge
                    let dayHtml = zipInfo.mailday || '-';
                    if (zipInfo.mailday === 'MON') {
                        dayHtml = '<span class="badge bg-warning text-dark">Monday</span>';
                    } else if (zipInfo.mailday === 'TUE') {
                        dayHtml = '<span class="badge bg-info text-white">Tuesday</span>';
                    }
                        
                    polygon.bindPopup(`
                        <div class="popup-content">
                            <strong>ZIP Code:</strong> ${zipInfo.zip_code}<br>
                            <strong>Machine:</strong> ${zipInfo.machine_name}<br>
                            <strong>Sequence:</strong> ${zipInfo.sequence || 'N/A'}<br>
                            <strong>Delivery Day:</strong> ${dayHtml}<br>
                            <strong>Postal:</strong> ${postalHtml}<br>
                            <strong>Insert Count:</strong> ${zipInfo.insert_count || '0'}<br>
                            <strong>Segments:</strong> ${segmentsHtml}
                        </div>
                    `, { minWidth: 200 });
                    
                    // Add click event to highlight corresponding ZIP in the list
                    polygon.on('click', function(e) {
                        // Stop propagation to prevent scrolling
                        L.DomEvent.stopPropagation(e);
                        
                        // Just highlight the item in the list without scrolling or opening accordion
                        highlightZipListItemOnly(zipInfo.zip_code);
                    });
                    
                    // Store polygon information for filtering
                    allZipLayers.push({
                        layer: polygon,
                        zipCode: zipInfo.zip_code,
                        mailday: zipInfo.mailday,
                        postalType: zipInfo.postal_type,
                        machine: zipInfo.machine_id
                    });
                    
                    processedZips.push(zipInfo.zip_code);
                } else {
                    // Fallback to marker for ZIPs not found in GeoJSON
                    addZipMarker(zipInfo);
                }
            });
            
            // Fit bounds to all polygons if we have any
            if (allZipLayers.length > 0) {
                const group = L.featureGroup(allZipLayers.map(z => z.layer));
                map.fitBounds(group.getBounds(), { padding: [30, 30] });
            }
        }
        
        // Function to only highlight ZIP in list without scrolling or opening accordion
        function highlightZipListItemOnly(zipCode) {
            document.querySelectorAll('.zip-list-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.zip === zipCode) {
                    item.classList.add('active');
                }
            });
        }
        
        // The original function for when ZIP list items are clicked (keeps accordion opening)
        function highlightZipInList(zipCode) {
            document.querySelectorAll('.zip-list-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.zip === zipCode) {
                    item.classList.add('active');
                    
                    // Get parent accordion-collapse
                    const accordionBody = item.closest('.accordion-collapse');
                    if (accordionBody && !accordionBody.classList.contains('show')) {
                        // Get the corresponding button
                        const accordionHeader = document.querySelector(`[data-bs-target="#${accordionBody.id}"]`);
                        if (accordionHeader) {
                            // Trigger click to open the accordion
                            accordionHeader.click();
                        }
                    }
                    
                    // Scroll into view with offset for header
                    setTimeout(() => {
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            });
        }
        
        // Function to add a ZIP code marker (fallback when GeoJSON not available)
        function addZipMarker(zipInfo) {
            if (!zipInfo || !zipInfo.zip_code) {
                return null;
            }
            
            // Default marker
            let markerColor = 'gray';
            
            // Set color based on scheduling method
            if (schedulingMethod === 'Postal Facility (SCF/DDU)') {
                if (zipInfo.postal_type === 'SCF') {
                    markerColor = 'green';
                } else if (zipInfo.postal_type === 'DDU') {
                    markerColor = 'purple';
                }
            } else if (schedulingMethod === 'Mayhem ☠️ (No Logic)') {
                // Mayhem mode - use red for all markers
                markerColor = 'red';
            } else {
                // Delivery day coloring
                if (zipInfo.mailday === 'MON') {
                    markerColor = 'gold';
                } else if (zipInfo.mailday === 'TUE') {
                    markerColor = 'blue';
                }
            }
            
            // We don't have coordinates in the data, so generate a point based on ZIP
            // This is a very rough approximation just for visualization
            const zipNum = parseInt(zipInfo.zip_code);
            const lat = 40.7 + (zipNum % 100) / 1000;
            const lng = -73.9 - (zipNum % 50) / 1000;
            
            const marker = L.circleMarker([lat, lng], {
                radius: 8,
                fillColor: markerColor,
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            
            // Add a tooltip
            marker.bindTooltip(zipInfo.zip_code, {
                permanent: false,
                direction: 'top',
                opacity: 0.8
            });
            
            // Add click event
            marker.on('click', function() {
                highlightZipInList(zipInfo.zip_code);
            });
            
            // Store marker info for filtering
            const markerInfo = {
                marker: marker,
                zipCode: zipInfo.zip_code,
                mailday: zipInfo.mailday,
                postalType: zipInfo.postal_type,
                machine: zipInfo.machine_id
            };
            
            allMarkers.push(markerInfo);
            return markerInfo;
        }
        
        // Function to filter markers and polygons by delivery day
        function filterZipsByDay(day) {
            // Hide all markers and polygons first
            allZipLayers.forEach(layer => {
                layer.layer.removeFrom(map);
            });
            
            allMarkers.forEach(markerInfo => {
                markerInfo.marker.removeFrom(map);
            });
            
            // Show markers based on filter
            const layersToShow = [];
            
            if (schedulingMethod === 'Postal Facility (SCF/DDU)') {
                // Filter by postal type
                if (day === 'SCF' || day === 'DDU') {
                    allZipLayers.forEach(layer => {
                        if (layer.postalType === day) {
                            layer.layer.addTo(map);
                            layersToShow.push(layer.layer);
                        }
                    });
                    
                    allMarkers.forEach(markerInfo => {
                        if (markerInfo.postalType === day) {
                            markerInfo.marker.addTo(map);
                            layersToShow.push(markerInfo.marker);
                        }
                    });
                } else {
                    // Show all if 'ALL' selected
                    allZipLayers.forEach(layer => {
                        layer.layer.addTo(map);
                        layersToShow.push(layer.layer);
                    });
                    
                    allMarkers.forEach(markerInfo => {
                        markerInfo.marker.addTo(map);
                        layersToShow.push(markerInfo.marker);
                    });
                }
            } else if (schedulingMethod === 'Mayhem ☠️ (No Logic)') {
                // In Mayhem mode, always show all ZIPs (no filtering)
                allZipLayers.forEach(layer => {
                    layer.layer.addTo(map);
                    layersToShow.push(layer.layer);
                });
                
                allMarkers.forEach(markerInfo => {
                    markerInfo.marker.addTo(map);
                    layersToShow.push(markerInfo.marker);
                });
            } else {
                // Filter by delivery day
                if (day === 'MON' || day === 'TUE') {
                    allZipLayers.forEach(layer => {
                        if (layer.mailday === day) {
                            layer.layer.addTo(map);
                            layersToShow.push(layer.layer);
                        }
                    });
                    
                    allMarkers.forEach(markerInfo => {
                        if (markerInfo.mailday === day) {
                            markerInfo.marker.addTo(map);
                            layersToShow.push(markerInfo.marker);
                        }
                    });
                } else {
                    // Show all if 'ALL' selected
                    allZipLayers.forEach(layer => {
                        layer.layer.addTo(map);
                        layersToShow.push(layer.layer);
                    });
                    
                    allMarkers.forEach(markerInfo => {
                        markerInfo.marker.addTo(map);
                        layersToShow.push(markerInfo.marker);
                    });
                }
            }
            
            // Update filter button states
            updateFilterButtonState(day);
            
            // Fit bounds to visible layers if we have any
            if (layersToShow.length > 0) {
                const group = L.featureGroup(layersToShow);
                map.fitBounds(group.getBounds(), { padding: [30, 30] });
            }
        }
        
        // Add click handlers to filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filterDay = this.dataset.filter;
                filterZipsByDay(filterDay);
            });
        });
        
        // Add click handlers to ZIP list items
        document.querySelectorAll('.zip-list-item').forEach(item => {
            item.addEventListener('click', function() {
                const zipCode = this.dataset.zip;
                
                // Find the layer for this ZIP
                const zipLayer = allZipLayers.find(layer => layer.zipCode === zipCode);
                if (zipLayer) {
                    // Zoom to this ZIP
                    map.fitBounds(zipLayer.layer.getBounds(), {
                        padding: [50, 50],
                        maxZoom: 15
                    });
                    
                    // Open popup
                    zipLayer.layer.openPopup();
                    
                    // Highlight in list
                    highlightZipInList(zipCode);
                }
                
                // Find marker as fallback
                const markerInfo = allMarkers.find(m => m.zipCode === zipCode);
                if (markerInfo && !zipLayer) {
                    // Zoom to the marker
                    map.setView(markerInfo.marker.getLatLng(), 13);
                    
                    // Open popup
                    markerInfo.marker.openPopup();
                    
                    // Highlight in list
                    highlightZipInList(zipCode);
                }
            });
        });
        
        // Function to update filter button states
        function updateFilterButtonState(selectedFilter) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                // Reset all buttons to their default state
                btn.classList.remove('btn-warning', 'btn-info', 'btn-success', 'btn-purple', 'btn-secondary');
                btn.classList.add('btn-outline-secondary');
                btn.style.backgroundColor = '';
                btn.style.color = '';
                btn.style.border = '';
                
                if (btn.dataset.filter === selectedFilter) {
                    // Apply appropriate styling based on the selected filter
                    btn.classList.remove('btn-outline-warning', 'btn-outline-info', 'btn-outline-success', 'btn-outline-secondary');
                    
                    if (schedulingMethod === 'Postal Facility (SCF/DDU)') {
                        if (selectedFilter === 'SCF') {
                            btn.classList.add('btn-success');
                            btn.style.backgroundColor = '#28a745';
                            btn.style.color = 'white';
                        } else if (selectedFilter === 'DDU') {
                            btn.classList.add('btn-secondary');
                            btn.style.backgroundColor = '#a17dc3';
                            btn.style.color = 'white';
                        } else {
                            btn.classList.add('btn-secondary');
                        }
                    } else if (schedulingMethod === 'Mayhem ☠️ (No Logic)') {
                        // No filters in Mayhem mode
                    } else {
                        if (selectedFilter === 'MON') {
                            btn.classList.add('btn-warning');
                        } else if (selectedFilter === 'TUE') {
                            btn.classList.add('btn-info');
                        } else {
                            btn.classList.add('btn-secondary');
                        }
                    }
                } else {
                    // Set appropriate outline style for unselected buttons
                    if (schedulingMethod === 'Postal Facility (SCF/DDU)') {
                        if (btn.dataset.filter === 'SCF') {
                            btn.classList.remove('btn-outline-secondary');
                            btn.classList.add('btn-outline-success');
                        } else if (btn.dataset.filter === 'DDU') {
                            btn.classList.remove('btn-outline-secondary');
                            btn.classList.add('btn-outline-secondary');
                            btn.style.border = '1px solid #a17dc3';
                            btn.style.color = '#a17dc3';
                        } else {
                            btn.classList.add('btn-outline-secondary');
                        }
                    } else if (schedulingMethod === 'Mayhem ☠️ (No Logic)') {
                        // No filters in Mayhem mode
                    } else {
                        if (btn.dataset.filter === 'MON') {
                            btn.classList.remove('btn-outline-secondary');
                            btn.classList.add('btn-outline-warning');
                        } else if (btn.dataset.filter === 'TUE') {
                            btn.classList.remove('btn-outline-secondary');
                            btn.classList.add('btn-outline-info');
                        } else {
                            btn.classList.add('btn-outline-secondary');
                        }
                    }
                }
            });
        }
        
        // Handle "Expand All" button
        document.getElementById('expandAllBtn').addEventListener('click', function() {
            // Toggle all accordion items
            document.querySelectorAll('.accordion-button.collapsed').forEach(btn => {
                btn.click();
            });
            
            // Update button text
            if (this.textContent === 'Expand All') {
                this.textContent = 'Collapse All';
            } else {
                this.textContent = 'Expand All';
                // Close all items
                document.querySelectorAll('.accordion-button:not(.collapsed)').forEach(btn => {
                    btn.click();
                });
            }
        });
        
        // Initialize the map
        initializeMap();
        
        // Show all ZIP codes by default
        filterZipsByDay('ALL');
    });
</script>
{% endblock %} 